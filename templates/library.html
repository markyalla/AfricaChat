<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Sankofa AI - Content Library</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        .africa-header {
            background: linear-gradient(135deg, #ff6b35, #f9844a);
            color: white;
            padding: 20px 0;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .content-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: none;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .content-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .africa-score-badge {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border-radius: 20px;
            padding: 5px 12px;
            font-size: 0.8em;
            display: inline-block;
        }
        
        .keywords-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        
        .keyword-tag {
            background: rgba(0, 123, 255, 0.1);
            color: #007bff;
            border: 1px solid rgba(0, 123, 255, 0.3);
            border-radius: 12px;
            padding: 3px 8px;
            font-size: 0.75em;
        }
        
        .search-box {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #6f42c1, #8e44ad);
            color: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }
        
        .filter-btn {
            border: 2px solid #007bff;
            color: #007bff;
            background: transparent;
            border-radius: 25px;
            padding: 8px 20px;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        .filter-btn.active,
        .filter-btn:hover {
            background: #007bff;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container my-4">
        <!-- Header -->
        <div class="africa-header">
            <h1><i class="bi bi-book"></i> Sankofa AI Library</h1>
            <p class="mb-0">Explore our collection of African history and culture</p>
        </div>

        <!-- Navigation -->
        <div class="mb-4">
            <a href="/" class="btn btn-outline-primary me-2">
                <i class="bi bi-chat-dots"></i> Chat
            </a>
            <a href="/upload" class="btn btn-outline-success me-2">
                <i class="bi bi-upload"></i> Upload Content
            </a>
        </div>

        <!-- Search and Filters -->
        <div class="search-box">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text" class="form-control" id="searchInput" 
                               placeholder="Search library content...">
                    </div>
                </div>
                <div class="col-md-6 mt-3 mt-md-0">
                    <div class="text-center">
                        <button class="filter-btn active" onclick="filterContent('all')">All</button>
                        <button class="filter-btn" onclick="filterContent('high-relevance')">High Africa Relevance</button>
                        <button class="filter-btn" onclick="filterContent('has-pdf')">With PDF</button>
                        <button class="filter-btn" onclick="filterContent('recent')">Recent</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="stats-card">
                    <h3 id="totalDocs">0</h3>
                    <small>Total Documents</small>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stats-card">
                    <h3 id="pdfDocs">0</h3>
                    <small>PDF Documents</small>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stats-card">
                    <h3 id="highRelevance">0</h3>
                    <small>High Relevance</small>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stats-card">
                    <h3 id="withImages">0</h3>
                    <small>With Images</small>
                </div>
            </div>
        </div>

        <!-- Content Grid -->
        <div class="row" id="contentGrid">
            {% if contents %}
                {% for content in contents %}
                <div class="col-md-6 col-lg-4 content-item" 
                     data-africa-score="{{ content.africa_score or 0 }}"
                     data-has-pdf="{{ 'true' if content.pdf_filename else 'false' }}"
                     data-created="{{ content.created_at.strftime('%Y-%m-%d') if content.created_at else '' }}"
                     data-content-id="{{ content.id }}"
                     data-title="{{ content.title|e }}"
                     data-keywords="{{ content.keywords or '' }}">
                    <div class="card content-card h-100">
                        {% if content.image_filename %}
                        <img src="/static/uploads/{{ content.image_filename }}" 
                             class="card-img-top" style="height: 200px; object-fit: cover;">
                        {% endif %}
                        
                        <div class="card-body d-flex flex-column">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title">{{ content.title }}</h5>
                                {% if content.africa_score and content.africa_score > 0 %}
                                <span class="africa-score-badge">
                                    <i class="bi bi-star-fill"></i> {{ "%.1f"|format(content.africa_score) }}
                                </span>
                                {% endif %}
                            </div>
                            
                            <p class="card-text flex-grow-1">
                                {% if content.content %}
                                    {% if content.content|length > 150 %}
                                        {{ content.content[:150] }}...
                                    {% else %}
                                        {{ content.content }}
                                    {% endif %}
                                {% else %}
                                    No description available
                                {% endif %}
                            </p>
                            
                            <!-- Keywords -->
                            {% if content.keywords %}
                            <div class="keywords-container">
                                {% set keywords = content.keywords.split(',') %}
                                {% for keyword in keywords[:5] %}
                                    {% if keyword.strip() %}
                                    <span class="keyword-tag">{{ keyword.strip() }}</span>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            {% endif %}
                            
                            <!-- Metadata -->
                            <div class="mt-3 pt-2 border-top">
                                <small class="text-muted d-flex justify-content-between">
                                    <span>
                                        {% if content.created_at %}
                                        <i class="bi bi-calendar"></i> {{ content.created_at.strftime('%Y-%m-%d') }}
                                        {% endif %}
                                    </span>
                                    <span>
                                        {% if content.pdf_filename %}
                                        <i class="bi bi-file-earmark-pdf text-danger"></i>
                                        {% endif %}
                                        {% if content.image_filename %}
                                        <i class="bi bi-image text-success"></i>
                                        {% endif %}
                                    </span>
                                </small>
                            </div>
                            
                           <!-- Actions -->
                            <div class="mt-3">
                                <button class="btn btn-primary btn-sm" onclick="viewContent('{{ content.id|tojson }}');">
                                    <i class="bi bi-eye"></i> View
                                </button>
                                {% if content.pdf_filename %}
                                <a href="/static/uploads/{{ content.pdf_filename }}" 
                                class="btn btn-outline-danger btn-sm" target="_blank">
                                    <i class="bi bi-download"></i> PDF
                                </a>
                                {% endif %}
                                <button class="btn btn-outline-success btn-sm" 
                                        data-content-title="{{ content.title|e }}"
                                        onclick="chatAboutFromButton(this)">
                                    <i class="bi bi-chat"></i> Chat
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="col-12">
                    <div class="text-center py-5">
                        <i class="bi bi-book display-1 text-muted"></i>
                        <h3 class="text-muted mt-3">No Content Available</h3>
                        <p class="text-muted">Start building your African history library!</p>
                        <a href="/upload" class="btn btn-primary">
                            <i class="bi bi-upload"></i> Upload First Document
                        </a>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Content Modal -->
    <div class="modal fade" id="contentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Content Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- Content will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="chatAboutBtn">
                        <i class="bi bi-chat"></i> Chat About This
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let allContent = [];
        let currentFilter = 'all';
        
        // Initialize content data and statistics from the page
        document.addEventListener('DOMContentLoaded', function() {
            updateStatistics();
            initializeContentData();
        });
        
        function initializeContentData() {
            const contentItems = document.querySelectorAll('.content-item');
            allContent = Array.from(contentItems).map(item => {
                const title = item.dataset.title || '';
                const content = item.querySelector('.card-text').textContent.trim();
                const keywords = item.dataset.keywords || '';
                
                return {
                    id: parseInt(item.dataset.contentId),
                    title: title,
                    content: content,
                    keywords: keywords,
                    africa_score: parseFloat(item.dataset.africaScore || 0),
                    has_pdf: item.dataset.hasPdf === 'true',
                    created_at: item.dataset.created
                };
            });
        }
        
        function updateStatistics() {
            const items = document.querySelectorAll('.content-item');
            const totalDocs = items.length;
            const pdfDocs = document.querySelectorAll('.content-item[data-has-pdf="true"]').length;
            const highRelevance = Array.from(items).filter(item => parseFloat(item.dataset.africaScore) >= 2).length;
            const withImages = document.querySelectorAll('.card-img-top').length;
            
            document.getElementById('totalDocs').textContent = totalDocs;
            document.getElementById('pdfDocs').textContent = pdfDocs;
            document.getElementById('highRelevance').textContent = highRelevance;
            document.getElementById('withImages').textContent = withImages;
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            filterAndSearch(currentFilter, searchTerm);
        });

        function filterContent(filter) {
            currentFilter = filter;
            
            // Update filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            filterAndSearch(filter, searchTerm);
        }

        function filterAndSearch(filter, searchTerm = '') {
            const items = document.querySelectorAll('.content-item');
            
            items.forEach(item => {
                let show = true;
                
                // Apply filter
                switch(filter) {
                    case 'high-relevance':
                        show = parseFloat(item.dataset.africaScore) >= 2;
                        break;
                    case 'has-pdf':
                        show = item.dataset.hasPdf === 'true';
                        break;
                    case 'recent':
                        const itemDate = new Date(item.dataset.created);
                        const thirtyDaysAgo = new Date();
                        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                        show = itemDate >= thirtyDaysAgo && !isNaN(itemDate.getTime());
                        break;
                    default:
                        show = true;
                }
                
                // Apply search
                if (show && searchTerm) {
                    const title = item.querySelector('.card-title').textContent.toLowerCase();
                    const content = item.querySelector('.card-text').textContent.toLowerCase();
                    const keywords = item.querySelectorAll('.keyword-tag');
                    let keywordText = '';
                    keywords.forEach(kw => keywordText += kw.textContent.toLowerCase() + ' ');
                    
                    show = title.includes(searchTerm) || 
                           content.includes(searchTerm) || 
                           keywordText.includes(searchTerm);
                }
                
                item.style.display = show ? 'block' : 'none';
            });
        }

        function viewContent(contentId) {
            // Find content by ID
            const content = allContent.find(c => c.id === contentId);
            if (!content) {
                alert('Content not found');
                return;
            }
            
            document.getElementById('modalTitle').textContent = content.title;
            
            let modalBody = '<div class="mb-3"><strong>Content:</strong><p>' + escapeHtml(content.content || 'No content available') + '</p></div>';
            
            if (content.keywords && content.keywords.trim()) {
                const keywordTags = content.keywords.split(',')
                    .map(kw => '<span class="keyword-tag">' + escapeHtml(kw.trim()) + '</span>')
                    .join(' ');
                modalBody += '<div class="mb-3"><strong>Keywords:</strong><br>' + keywordTags + '</div>';
            }
            
            modalBody += '<div class="mb-3"><strong>Africa Relevance Score:</strong> ' + (content.africa_score || 0) + '</div>';
            
            if (content.created_at) {
                modalBody += '<div class="mb-3"><strong>Created:</strong> ' + escapeHtml(content.created_at) + '</div>';
            }
            
            if (content.has_pdf) {
                modalBody += '<div class="mb-3"><i class="bi bi-file-earmark-pdf text-danger"></i> PDF document available for download</div>';
            }
            
            document.getElementById('modalBody').innerHTML = modalBody;
            document.getElementById('chatAboutBtn').onclick = function() { 
                chatAbout(content.title); 
            };
            
            new bootstrap.Modal(document.getElementById('contentModal')).show();
        }

        // Helper function to handle chat button clicks
        function chatAboutFromButton(button) {
            const title = button.getAttribute('data-content-title');
            chatAbout(title);
        }

        function chatAbout(topic) {
            // Close modal if open
            const modal = bootstrap.Modal.getInstance(document.getElementById('contentModal'));
            if (modal) modal.hide();
            
            // Redirect to chat with topic
            const encodedTopic = encodeURIComponent(topic);
            window.location.href = '/?topic=' + encodedTopic;
        }

        // Helper function to escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }
    </script>
</body>
</html>