<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Sankofa AI - Debug Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .debug-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .log-entry {
            font-family: monospace;
            font-size: 12px;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
    </style>
</head>
<body>
    <div class="container my-4">
        <h2>Sankofa AI - Debug Test Page</h2>
        
        <div class="debug-section">
            <h4>Test API Connection</h4>
            <button class="btn btn-primary" onclick="testAPI()">Test API</button>
            <button class="btn btn-secondary" onclick="clearLogs()">Clear Logs</button>
        </div>

        <div class="debug-section">
            <h4>Quick Test Queries</h4>
            <button class="btn btn-success btn-sm" onclick="testQuery('Amapiano')">Test: Amapiano</button>
            <button class="btn btn-success btn-sm" onclick="testQuery('Mansa Musa')">Test: Mansa Musa</button>
            <button class="btn btn-success btn-sm" onclick="testQuery('African music')">Test: African music</button>
            <button class="btn btn-success btn-sm" onclick="testQuery('Hello')">Test: Hello (simple)</button>
        </div>

        <div class="debug-section">
            <h4>Custom Query</h4>
            <div class="input-group mb-3">
                <input type="text" class="form-control" id="customQuery" placeholder="Enter your query">
                <button class="btn btn-primary" onclick="testCustomQuery()">Send</button>
            </div>
        </div>

        <div class="debug-section">
            <h4>Debug Logs</h4>
            <div id="debugLogs" style="max-height: 400px; overflow-y: auto; background: white; padding: 10px; border-radius: 5px;">
                <div class="log-entry info">Ready to test...</div>
            </div>
        </div>

        <div class="debug-section">
            <h4>Response Preview</h4>
            <div id="responsePreview" style="background: white; padding: 15px; border-radius: 5px; min-height: 100px;">
                <em>No response yet</em>
            </div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('debugLogs');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logsDiv.appendChild(entry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('debugLogs').innerHTML = '<div class="log-entry info">Logs cleared...</div>';
            document.getElementById('responsePreview').innerHTML = '<em>No response yet</em>';
        }

        async function testAPI() {
            log('Testing basic API connectivity...', 'info');
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: 'test' })
                });
                
                log(`Response status: ${response.status} ${response.statusText}`, 
                    response.ok ? 'success' : 'error');
                
                const contentType = response.headers.get('content-type');
                log(`Content-Type: ${contentType}`, 'info');
                
                const text = await response.text();
                log(`Raw response length: ${text.length} chars`, 'info');
                log(`Raw response preview: ${text.substring(0, 200)}...`, 'info');
                
                try {
                    const data = JSON.parse(text);
                    log('✓ Valid JSON response', 'success');
                    log(`Response keys: ${Object.keys(data).join(', ')}`, 'info');
                    
                    document.getElementById('responsePreview').innerHTML = 
                        `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                } catch (e) {
                    log(`✗ Invalid JSON: ${e.message}`, 'error');
                    document.getElementById('responsePreview').innerHTML = 
                        `<strong>Raw Response:</strong><br>${text}`;
                }
                
            } catch (error) {
                log(`✗ Network error: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }

        async function testQuery(query) {
            log(`\n--- Testing query: "${query}" ---`, 'info');
            
            try {
                log('Sending request...', 'info');
                
                const startTime = Date.now();
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: query })
                });
                const duration = Date.now() - startTime;
                
                log(`Response received in ${duration}ms`, 'info');
                log(`Status: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (!response.ok) {
                    const errorText = await response.text();
                    log(`Error response: ${errorText}`, 'error');
                    return;
                }
                
                const data = await response.json();
                log('✓ Successfully parsed JSON', 'success');
                
                if (data.error) {
                    log(`✗ API returned error: ${data.error}`, 'error');
                } else if (data.response) {
                    log(`✓ Got response (${data.response.length} chars)`, 'success');
                    log(`Source: ${data.source || 'N/A'}`, 'info');
                    log(`Suggestions: ${data.suggestions ? data.suggestions.length : 0}`, 'info');
                    log(`Offline mode: ${data.offline_mode}`, 'info');
                    
                    document.getElementById('responsePreview').innerHTML = 
                        `<strong>Response:</strong><br>${data.response.replace(/\n/g, '<br>')}
                         <br><br><strong>Source:</strong> ${data.source || 'N/A'}
                         <br><strong>Suggestions:</strong> ${data.suggestions ? data.suggestions.join(', ') : 'None'}`;
                } else {
                    log('✗ Response missing expected data', 'error');
                    log(`Response structure: ${JSON.stringify(Object.keys(data))}`, 'info');
                }
                
            } catch (error) {
                log(`✗ Error: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }

        function testCustomQuery() {
            const query = document.getElementById('customQuery').value.trim();
            if (!query) {
                log('Please enter a query', 'error');
                return;
            }
            testQuery(query);
        }

        // Allow Enter key
        document.getElementById('customQuery').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') testCustomQuery();
        });

        // Auto-test on load
        window.addEventListener('load', () => {
            log('Page loaded. Click "Test API" to begin.', 'success');
        });
    </script>
</body>
</html>